# SPDX-License-Identifier: GPL-2.0-only
name: Build ILI9481 Kernel Module

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: "Raspberry Pi kernel branch"
        required: true
        default: "rpi-6.12.y"
        type: choice
        options:
          - rpi-6.12.y
          - rpi-6.6.y

env:
  KERNEL_BRANCH: ${{ github.event.inputs.kernel_branch || 'rpi-6.12.y' }}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            cross_compile: aarch64-linux-gnu-
            gcc_pkg: gcc-aarch64-linux-gnu
            defconfig: bcm2711_defconfig
          # To add armhf (32-bit) support, uncomment below:
          # - arch: arm
          #   cross_compile: arm-linux-gnueabihf-
          #   gcc_pkg: gcc-arm-linux-gnueabihf
          #   defconfig: bcm2711_defconfig

    name: Build (${{ matrix.arch }}, ${{ matrix.defconfig }})

    steps:
      - name: Checkout driver source
        uses: actions/checkout@v4

      - name: Install toolchain & dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            ${{ matrix.gcc_pkg }} \
            device-tree-compiler \
            bc bison flex libssl-dev

      - name: Cache kernel source
        id: cache-kernel
        uses: actions/cache@v4
        with:
          path: ~/kernel-source
          key: kernel-v3-${{ env.KERNEL_BRANCH }}-${{ matrix.arch }}-${{ matrix.defconfig }}

      - name: Clone Raspberry Pi kernel (cache miss)
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 --branch "$KERNEL_BRANCH" \
            https://github.com/raspberrypi/linux.git ~/kernel-source

      - name: Prepare kernel headers (cache miss)
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        run: |
          cd ~/kernel-source
          make ARCH=${{ matrix.arch }} CROSS_COMPILE=${{ matrix.cross_compile }} \
            ${{ matrix.defconfig }}
          make ARCH=${{ matrix.arch }} CROSS_COMPILE=${{ matrix.cross_compile }} \
            modules_prepare

      - name: Cross-compile check
        run: |
          make -C ~/kernel-source \
            ARCH=${{ matrix.arch }} \
            CROSS_COMPILE=${{ matrix.cross_compile }} \
            M=$GITHUB_WORKSPACE \
            KBUILD_MODPOST_WARN=1 \
            modules

      - name: Compile device tree overlays
        run: |
          dtc -@ -Hepapr -I dts -O dtb \
            -o ili9481.dtbo ili9481-overlay.dts
          dtc -@ -Hepapr -I dts -O dtb \
            -o xpt2046.dtbo xpt2046-overlay.dts

      - name: Stage install package
        run: |
          mkdir -p package
          # Pre-compiled device-tree overlays (arch-independent)
          cp ili9481.dtbo package/
          cp xpt2046.dtbo package/
          # Source files for on-device DKMS build
          cp ili9481.c package/
          cp Makefile package/
          cp Kconfig package/
          cp dkms.conf package/
          # Installer
          cp install.sh package/
          chmod +x package/install.sh
          # Build metadata
          echo "kernel_branch=${{ env.KERNEL_BRANCH }}" > package/BUILD_INFO
          echo "compile_check_arch=${{ matrix.arch }}" >> package/BUILD_INFO
          echo "defconfig=${{ matrix.defconfig }}" >> package/BUILD_INFO
          echo "built=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> package/BUILD_INFO

      - name: Verify
        run: |
          echo "=== Cross-compile check ==="
          modinfo ili9481.ko
          echo ""
          echo "=== Device tree overlays ==="
          file package/ili9481.dtbo
          file package/xpt2046.dtbo
          echo ""
          echo "=== Package contents ==="
          ls -la package/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ili9481-${{ matrix.arch }}-${{ env.KERNEL_BRANCH }}
          path: package/
          retention-days: 30
